const loadDevices=async()=>await fetch("/json").then(e=>e.json()).then(e=>e.Sensors),getConfigNodes=async()=>{const e=await loadDevices(),t=[];return{nodes:e.map(e=>{e.TaskValues.forEach(n=>t.push(`${e.TaskName}#${n.Name}`));const n=[{group:"TRIGGERS",type:e.TaskName,inputs:[],outputs:[1],config:[{name:"variable",type:"select",values:e.TaskValues.map(e=>e.Name),value:e.TaskValues[0].Name},{name:"euqality",type:"select",values:["","=","<",">","<=",">=","!="],value:""},{name:"value",type:"number"}],indent:!0,toString:function(){const e=""===this.config[1].value?"changes":`${this.config[1].value} ${this.config[2].value}`;return`when ${this.type}.${this.config[0].value} ${e}`},toDsl:function(){const e=""===this.config[1].value?"":`${this.config[1].value}${this.config[2].value}`;return[`on ${this.type}#${this.config[0].value}${e} do\n%%output%%\nEndon\n`]}}];let a,s;switch(e.Type){case"Regulator - Level Control":n.push({group:"ACTIONS",type:`${e.TaskName} - setlevel`,inputs:[1],outputs:[1],config:[{name:"value",type:"number"}],toString:function(){return`${e.TaskName}.level = ${this.config[0].value}`},toDsl:function(){return[`config,task,${e.TaskName},setlevel,${this.config[0].value}`]}});break;case"PCA9685":case"PCF8574":case"MCP23017":s=(a={PCA9685:"PCF",PCF8574:"PCF",MCP23017:"MCP"})[e.Type],n.push({group:"ACTIONS",type:`${e.TaskName} - GPIO`,inputs:[1],outputs:[1],config:[{name:"pin",type:"select",values:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]},{name:"value",type:"select",values:[0,1]}],toString:function(){return`${e.TaskName}.pin${this.config[0].value} = ${this.config[1].value}`},toDsl:function(){return[`${s}GPIO,${this.config[0].value},${this.config[1].value}`]}}),n.push({group:"ACTIONS",type:`${e.TaskName} - Pulse`,inputs:[1],outputs:[1],config:[{name:"pin",type:"select",values:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]},{name:"value",type:"select",values:[0,1]},{name:"unit",type:"select",values:["ms","s"]},{name:"duration",type:"number"}],toString:function(){return`${e.TaskName}.pin${this.config[0].value} = ${this.config[1].value} for ${this.config[3].value}${this.config[2].value}`},toDsl:function(){return"s"===this.config[2].value?[`${s}LongPulse,${this.config[0].value},${this.config[1].value},${this.config[2].value}`]:[`${s}Pulse,${this.config[0].value},${this.config[1].value},${this.config[2].value}`]}});break;case"ProMiniExtender":n.push({group:"ACTIONS",type:`${e.TaskName} - GPIO`,inputs:[1],outputs:[1],config:[{name:"pin",type:"select",values:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]},{name:"value",type:"select",values:[0,1]}],toString:function(){return`${e.TaskName}.pin${this.config[0].value} = ${this.config[1].value}`},toDsl:function(){return[`EXTGPIO,${this.config[0].value},${this.config[1].value}`]}});break;case"OLEDDisplay":case"LCDDisplay":s=(a={OLEDDisplay:"OLED",LCDDisplay:"LCD"})[e.Type],n.push({group:"ACTIONS",type:`${e.TaskName} - Write`,inputs:[1],outputs:[1],config:[{name:"row",type:"select",values:[1,2,3,4]},{name:"column",type:"select",values:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]},{name:"text",type:"text"}],toString:function(){return`${e.TaskName}.text = ${this.config[2].value}`},toDsl:function(){return[`${s},${this.config[0].value},${this.config[1].value},${this.config[2].value}`]}});break;case"Generic - Dummy Device":n.push({group:"ACTIONS",type:`${e.TaskName} - Write`,inputs:[1],outputs:[1],config:[{name:"variable",type:"select",values:e.TaskValues.map(e=>e.Name)},{name:"value",type:"text"}],toString:function(){return`${e.TaskName}.${this.config[0].value} = ${this.config[1].value}`},toDsl:function(){return[`TaskValueSet,${e.TaskNumber},${this.config[0].values.findIndex(this.config[0].value)},${this.config[1].value}`]}})}return n}).flat(),vars:t}},storeConfig=async e=>{const t=new FormData;return t.append("edit",1),t.append("file",new File([new Blob([e])],"r1.txt")),await fetch("/upload",{method:"post",body:t})},loadConfig=async()=>await fetch("/r1.txt").then(e=>e.json()),storeRule=async e=>{const t=new FormData;return t.append("set",1),t.append("rules",e),await fetch("/rules",{method:"post",body:t})};